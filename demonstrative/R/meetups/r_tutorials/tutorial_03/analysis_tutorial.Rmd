---
title: "R Notebook"
output: html_notebook
---

```{r init, results='hide', warning=F, message=F, error=F, echo=F}
library(dplyr)
library(ggplot2)
library(corrplot)
library(knitr)
library(stringr)
library(caret)
library(plotly)
layout <- plotly::layout

# Paper on data:
# Multiplexed Immunoassay Panel Identifies Novel CSF Biomarkers for Alzheimer's Disease Diagnosis and Prognosis
# library(AppliedPredictiveModeling)
# ?diagnosis
```

```{r}
# Load in the whole Alzheimers data file
data <- read.csv('~/repos/portfolio/demonstrative/R/datasets/alzheimers/alzheimers.csv')

# Remove this field ... I forgot to do that when creating the dataset
data <- data %>% select(-male)

# Normalize gender labels
stopifnot(all(!is.na(data$gender)))
normalize.gender <- function(x) {
  is.male <- x %>% tolower %>% str_detect('^m')
  ifelse(is.male, 'Male', 'Female') %>% factor
}
data <- data %>% mutate(gender=normalize.gender(gender))

# Convert integer fields to numeric for the sake of consistency
data <- data %>% mutate_each_(funs(as.numeric), c('Betacellulin', 'Eotaxin_3'))

head(data)
```

```{r}
X <- data %>% select(-response)
y <- data[,'response']
table(y)
```

```{r}
names(X)
```

```{r}
X %>% sapply(class) %>% table
```

```{r}
#X %>% sapply(class) %>% .[. == 'factor']
names(X)[sapply(X, class) == 'factor']
```

# Partial Analysis

We could start by looking at the relationship between some of the more intuitive variables like Age, Gender, and Genotype and impairment, to see if there are any obvious relationships.

Age vs Impairment

```{r}
data %>% 
  mutate(age_range=cut(age, breaks=5)) %>%
  group_by(age_range, response) %>% tally %>% 
  plot_ly(x=~age_range, y=~n, color=~response, type='bar') %>%
  plotly::layout(hovermode='closest')
```


Genotype vs Impairment

```{r}
data %>% 
  group_by(Genotype, response) %>% tally %>% 
  plot_ly(x=~Genotype, y=~n, color=~response, type='bar') %>%
  plotly::layout(hovermode='closest')
```


Gender vs Impairment

```{r}
data %>% 
  group_by(gender, response) %>% tally %>% 
  plot_ly(x=~gender, y=~n, color=~response, type='bar') %>%
  plotly::layout(hovermode='closest')
```

# ```{r}
# data %>% plot_ly(x=~gender, y=~age, type='box')
# ```

### Protein Analysis

Now what about the other ~125 variables?  We can't look at them all one at a time so perhaps there is a way to "condense" them into something more manageable:


```{r, fig.width=10, fig.height=10}
library(corrplot)
d.pca <- X %>% select(-gender, -Genotype)
cor.mat <- corrplot(cor(d.pca), order='hclust', tl.col='black', tl.cex=.5)

# Extract the variable names from the figure below since they will be useful
# for creating similar plots for comparison (and it's easier to compare in the same order)
cor.var <- rownames(cor.mat)
```


```{r}
#d.pca <- X %>% select(-gender, -Genotype)
pca <- prcomp(d.pca, scale=T)
```


<!-- # The code below will plot the PCA loadings (ie pca$rotation) matrix -->
<!-- # directly rather than looking at correlations between original and transformed variables -->
<!-- # (though these show about the same thing) -->

<!--
{r, fig.height=10, fig.width=6}
library(reshape2)
dp <- pca$rotation[,1:25][cor.var,] %>% as.data.frame %>%
  add_rownames(var='feature') %>%
  melt(id.vars='feature', variable.name='pc')
dp$feature <- factor(dp$feature, levels=rev(cor.var))
dp %>% ggplot(aes(x=pc, y=feature, fill=value)) + geom_tile() +
  scale_fill_gradient2(low='red', high='blue', mid='white')
-->

```{r, fig.width=4, fig.height=10}
corrplot(cor(d.pca[,cor.var], pca$x[,1:25]), tl.col='black', tl.cex=.5)
```


```{r, fig.width=10, fig.height=10}
i.pca <- c(2,3)
d.pca.pred <- as.data.frame(predict(pca, d.pca)[,i.pca]) %>% setNames(., c('PC1', 'PC2'))
d.pca.pred$response <- y

pca.vars <- c('tau', 'Ab_42')
d.pca.var <- pca$rotation[,i.pca] %>% 
  as.data.frame %>% setNames(., c('PC1', 'PC2')) %>%
  add_rownames(var='variable') %>%
  filter(variable %in% pca.vars) 

extend.num <- function(x) unlist(lapply(x, function(v) c(0, v, NA)))
extend.var <- function(x) unlist(lapply(x, function(v) c(NA, v, NA)))
d.pca.var <- data.frame(
  variable=extend.var(d.pca.var$variable),
  PC1=extend.num(d.pca.var$PC1),
  PC2=extend.num(d.pca.var$PC2)
)

# Parameters for axis with no grid lines, ticks or labels
empty.axis <- list(
  title = '',
  zeroline = FALSE,
  showline = FALSE,
  showticklabels = FALSE,
  ticklen = 0,
  showgrid = FALSE
)

# Create a line plot of each variable showing which direction it moves within our 2D space
p1 <- plot_ly(
    d.pca.var, x=~PC1, y=~PC2, text=~variable, type='scatter', 
    mode='lines+text', opacity=1, line=list(color='black'), textfont=list(color='white', size=14)
  ) %>% layout(
    xaxis=list(range = c(-.5, .5), showgrid=F, zeroline=F), 
    yaxis=list(showgrid=F, zeroline=F)
  )

# Create a heatmap of impairment incidence rate across our 2D space
d.hm <- d.pca.pred %>% 
  mutate(PC1=as.character(cut(PC1, breaks=3)), PC2=as.character(cut(PC2, breaks=3))) %>%
  group_by(PC1, PC2) %>% summarise(PCT=100*sum(response == 'Impaired')/n()) %>%
  acast(PC1 ~ PC2, value.var='PCT')
p2 <- plot_ly(z=d.hm, type='heatmap', reversescale=T) %>%
  layout(xaxis=empty.axis, yaxis=empty.axis)

# Overlay the above plots on top of one another
subplot(p2, p1, margin=-1) %>% 
  layout(
    paper_bgcolor='rgba(0,0,0,0)', plot_bgcolor='rgba(0,0,0,0)', 
    width=750, height=500,
    title='2D Projection of Correlated Features Overlayed w/ Impairment Rates'
  )
```


# Simple Regression Models

```{r}

```


```{r}
# library(caret)
# set.seed(1)
# m <- train(X, y, method='rf', trControl=trainControl(method='cv', number=10))
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file).
